#upstream alaveteli {
#    server 127.0.0.1:3000;
#}

# Redirect any http://{{ alaveteli_host }} request to https://{{ alaveteli_host }}
server {
  listen 80;
  server_name {{ alaveteli_host }};
  rewrite ^(.*) https://{{ alaveteli_host }}$request_uri permanent;
}

server {
    listen {{ nginx_https_port }};
    server_name {{ alaveteli_host }};
    root /var/www/alaveteli/alaveteli/public;

    server_tokens off;

    try_files $uri/index.html $uri @alaveteli;

    access_log /var/log/nginx/alaveteli_ssl_access.log;
    error_log /var/log/nginx/alaveteli_ssl_error.log error;

    location /download {
        internal;
        alias /var/www/alaveteli/alaveteli/cache/zips/production/download;
    }

    # ACME Challange location
    location /.well-known/acme-challenge {
      alias /var/www/letsencrypt/;
      location ~ /.well-known/acme-challenge/(.*) {
        add_header Content-Type application/jose+json;
      }
    }

    location ^~ /assets/ {
      gzip_static on;
      expires max;
      add_header Cache-Control public;
    }

    {% if alaveteli_host == 'alaveteli.org.dev' %}
    add_header Strict-Transport-Security max-age=0;
    {% else %}
    add_header Strict-Transport-Security max-age=31536000;
    {% endif %}

    #The TLS settings will be enabled only after Let's Encrypt runs the ACME challange
    ssl on;
    ssl_certificate /etc/ssl/{{ alaveteli_host }}.pem;
    ssl_certificate_key /etc/ssl/private/{{ alaveteli_host }}.key;
    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
    ssl_prefer_server_ciphers on;
    ssl_session_cache  builtin:1000  shared:SSL:10m;
    ssl_ciphers "EECDH+AESGCM:EDH+AESGCM:ECDHE-RSA-AES128-GCM-SHA256:AES256+EECDH:DHE-RSA-AES128-GCM-SHA256:AES256+EDH:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA:ECDHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES128-SHA256:DHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA:ECDHE-RSA-DES-CBC3-SHA:EDH-RSA-DES-CBC3-SHA:AES256-GCM-SHA384:AES128-GCM-SHA256:AES256-SHA256:AES128-SHA256:AES256-SHA:AES128-SHA:DES-CBC3-SHA:HIGH:!aNULL:!eNULL:!EXPORT:!DES:!MD5:!PSK:!RC4";
    ssl_dhparam /etc/ssl/private/{{ alaveteli_host }}_dhparams.pem;

    location @alaveteli {
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP  $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header X-Sendfile-Type X-Accel-Redirect;
        proxy_set_header X-Accel-Mapping /var/www/alaveteli/alaveteli/cache/zips/production/download=/download;
        proxy_redirect off;
        proxy_pass http://alaveteli;
    }
}
